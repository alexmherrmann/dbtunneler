<html>

<head>
    <title>Tunny</title>
    <!-- include the assets/base.css -->
    <link rel="stylesheet" href="/assets/base.css">
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script>
        document.addEventListener("alpine:init", async () => {
            Alpine.store('top', {
                state: {},
                loaded: false,
                async fetchData() {
                    const response = await fetch("/api/state");
                    const data = await response.json();
                    this.state = data;
                    this.loaded = true;
                },
                init() {
                    // this.fetchData();
                }
            })

            async function runPeriodically() {
                await Alpine.store('top').fetchData(); // Wait for fetchData to complete
                setTimeout(runPeriodically, 2000); // Then wait an additional 1000 ms before next run
            }

            await runPeriodically();

            // setInterval(() => {
            //     Alpine.store('top').fetchData();
            // }, 2000);
        })
    </script>
</head>

<body>
    <div id="top" x-data="$store.top">
        <h1>Tunny</h1>
        <template x-if="!loaded">
            <div>Loading...</div>
        </template>
        <ul id="targetlist">
            <template x-for="target in state.targets">
                <li>
                    <div x-text="target.name"></div>
                    <ul id="loglist">
                        <template x-for="info in state.info[target.name]">
                            <li class="infoitem">
                                <div x-text="info"></div>
                            </li>
                        </template>
                        <template x-for="error in state.warn[target.name]">
                            <li class="erroritem">
                                <div x-text="error"></div>
                            </li>
                        </template>
                        <template x-for="fatal in state.fatal[target.name]">
                            <li class="fatalitem">
                                <div x-text="fatal"></div>
                            </li>
                        </template>
                    </ul>
                </li>
            </template>
        </ul>
    </div>

    <!-- <div x-data="{ count: 0 }">
        <button x-on:click="count++">Increment</button>

        <span x-text="count"></span>
    </div> -->

</body>

</html>